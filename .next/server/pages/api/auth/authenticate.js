"use strict";(()=>{var e={};e.id=591,e.ids=[591],e.modules={9344:e=>{e.exports=require("jsonwebtoken")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},7773:e=>{e.exports=require("winston")},6249:(e,r)=>{Object.defineProperty(r,"l",{enumerable:!0,get:function(){return function e(r,t){return t in r?r[t]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,t)):"function"==typeof r&&"default"===t?r:void 0}}})},7971:(e,r,t)=>{t.r(r),t.d(r,{config:()=>w,default:()=>A,routeModule:()=>v});var n={};t.r(n),t.d(n,{default:()=>P});var o=t(1802),s=t(7153),a=t(6249),i=t(9344),u=t.n(i);let l=require("crypto");var c=t.n(l),f=t(1417),p=t(8077);let d=process.env.JWT_SECRET;function g(){return{"User-Agent":process.env.USER_AGENT,Accept:"application/json","Content-Type":"application/json",Origin:process.env.ORIGIN,Referer:process.env.REFERER}}async function h(e,r,t){try{let n=await fetch(process.env.AUTH_URL,{method:"POST",headers:g(),body:JSON.stringify({username:e,password:r,application_key:t})});if(!n.ok)return p.logger.error(`Auth error: ${n.status} - ${await n.text()}`),null;return(await n.json()).access_token||null}catch(e){return p.logger.error("Auth request error:",e),null}}async function m(e){try{let r=await fetch(process.env.USER_INFO,{method:"GET",headers:{...g(),Authorization:`Bearer ${e}`}});if(!r.ok)return p.logger.error(`User info fetch error: ${r.status} - ${await r.text()}`),null;let t=await r.json();return function(e){if(!e)return null;let r=e.trim().split(/\s+/);return r.length>=2?r[1]:null}(t.full_name)}catch(e){return p.logger.error("Fetch user info error:",e),null}}async function E(e,r,t){let n;let o=process.env.ENCRYPTION_KEY;if(!o)return p.logger.error("Ошибка: не удалось загрузить ключ шифрования."),null;try{let s;n=await (0,f.B)();let a=function(e,r){let t=c().randomBytes(16),n=c().createCipheriv("aes-256-cbc",Buffer.from(r,"hex"),t),o=n.update(e,"utf8","hex");return o+=n.final("hex"),t.toString("hex")+":"+o}(r,o),[i]=await n.execute("SELECT user_id FROM users WHERE login = ?",[e]);if(0===i.length){let[r]=await n.execute("INSERT INTO users (login, password, token) VALUES (?, ?, ?)",[e,a,t]);s=r.insertId,p.logger.info(`Новый пользователь с логином ${e} добавлен в базу.`)}else s=i[0].user_id,await n.execute("UPDATE users SET password = ?, token = ? WHERE user_id = ?",[a,t,s]),p.logger.info(`Данные пользователя с логином ${e} обновлены.`);return s}catch(e){return p.logger.error("Database error:",e),null}finally{n&&n.release()}}async function P(e,r){if("POST"===e.method)try{let{login:t,password:n}=e.body,o=process.env.APPLICATION_KEY;if(!t||!n||!o)return r.status(400).json({error:"Необходимы login, password и application_key"});let s=await h(t,n,o);if(!s)return r.status(401).json({error:"Не удалось авторизоваться. Проверьте введенные данные."});let a=await m(s),i=await E(t,n,s),l=u().sign({login:t,name:a,userId:i},d,{expiresIn:"7d"});return r.setHeader("Set-Cookie",`token=${l}; HttpOnly; Path=/; Max-Age=604800; SameSite=Strict`),r.status(200).json({message:"Авторизация успешна",token:l,user:{login:t,name:a}})}catch(e){return p.logger.error("Authentication error:",e),r.status(500).json({error:"Internal server error"})}else if("GET"!==e.method)return r.status(405).json({error:"Method not allowed"});else try{let t=e.cookies.token;if(!t)return r.status(401).json({error:"Нет токена, пользователь не авторизован"});let n=u().verify(t,d);return r.status(200).json({user:n})}catch(e){return r.status(401).json({error:"Неверный или просроченный токен"})}}let A=(0,a.l)(n,"default"),w=(0,a.l)(n,"config"),v=new o.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/auth/authenticate",pathname:"/api/auth/authenticate",bundlePath:"",filename:""},userland:n})},1417:(e,r,t)=>{t.d(r,{B:()=>s});let n=require("mysql2/promise"),o=t.n(n)().createPool({host:process.env.DB_HOST,user:process.env.DB_USER,password:process.env.DB_PASSWORD,database:process.env.DB_NAME,waitForConnections:!0,connectionLimit:10,queueLimit:0});async function s(){return await o.getConnection()}},8077:(e,r,t)=>{let n=t(7773),o=n.createLogger({level:"info",format:n.format.combine(n.format.timestamp(),n.format.printf(({level:e,message:r,timestamp:t})=>`${t} - ${e.toUpperCase()} - ${r}`)),transports:[new n.transports.Console,new n.transports.File({filename:"logs/error.log",level:"error"}),new n.transports.File({filename:"logs/combined.log"})]});e.exports={logger:o}},7153:(e,r)=>{var t;Object.defineProperty(r,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))},1802:(e,r,t)=>{e.exports=t(145)}};var r=require("../../../webpack-api-runtime.js");r.C(e);var t=r(r.s=7971);module.exports=t})();