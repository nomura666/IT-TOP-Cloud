"use strict";(()=>{var e={};e.id=668,e.ids=[668],e.modules={4802:e=>{e.exports=require("cookie")},9344:e=>{e.exports=require("jsonwebtoken")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},7773:e=>{e.exports=require("winston")},2048:e=>{e.exports=require("fs")},5315:e=>{e.exports=require("path")},6249:(e,r)=>{Object.defineProperty(r,"l",{enumerable:!0,get:function(){return function e(r,t){return t in r?r[t]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,t)):"function"==typeof r&&"default"===t?r:void 0}}})},1114:(e,r,t)=>{t.r(r),t.d(r,{config:()=>j,default:()=>E,routeModule:()=>b});var n={};t.r(n),t.d(n,{config:()=>_,default:()=>x});var i=t(1802),o=t(7153),s=t(6249);let a=require("multer");var l=t.n(a),u=t(9344),f=t.n(u),m=t(1417),p=t(8077),c=t(5315),d=t.n(c),P=t(2048),g=t.n(P),v=t(4802),y=t.n(v);let A=process.env.JWT_SECRET,S=d().resolve("./uploads");g().existsSync(S)||g().mkdirSync(S,{recursive:!0});let w=l().diskStorage({destination:(e,r,t)=>{t(null,S)},filename:(e,r,t)=>{t(null,Date.now()+"-"+r.originalname)}});l()({storage:w});let _={api:{bodyParser:!1}};async function x(e,r){if("POST"!==e.method)return r.status(405).json({error:"Метод не поддерживается"});try{let t;let n=y().parse(e.headers.cookie||"").token;if(!n)return r.status(401).json({error:"Токен не найден в куках"});try{t=f().verify(n,A)}catch(e){return r.status(401).json({error:"Неверный или просроченный токен"})}let i=t.userId,o=d().join(S,`user_${i}`);g().existsSync(o)||g().mkdirSync(o,{recursive:!0});let s=l().diskStorage({destination:(e,r,t)=>{t(null,o)},filename:(e,r,t)=>{let n=Date.now()+"-"+r.originalname;t(null,n)}}),a=l()({storage:s});if(await new Promise((t,n)=>{a.single("file")(e,r,e=>{if(e){n(Error("Ошибка при загрузке файла"));return}t()})}),!e.file)return r.status(400).json({error:"Файл не загружен"});let u=await (0,m.B)();try{let t=[i,e.file.originalname,e.file.filename,e.file.size,e.file.mimetype];return p.logger.error(`Upload error: userId=${i}, originalName=${e.file?.originalname}, serverName=${e.file?.filename}, size=${e.file?.size}, mimeType=${e.file?.mimetype}`),await u.execute("INSERT INTO files (owner_id, original_name, server_name, size, mime_type) VALUES (?, ?, ?, ?, ?)",t),r.status(201).json({message:"Файл успешно загружен",file:e.file.filename})}finally{u.release()}}catch(e){return console.error("Ошибка в API:",e),r.status(500).json({error:e.message||"Ошибка сервера"})}}let E=(0,s.l)(n,"default"),j=(0,s.l)(n,"config"),b=new i.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/files/upload",pathname:"/api/files/upload",bundlePath:"",filename:""},userland:n})},1417:(e,r,t)=>{t.d(r,{B:()=>o});let n=require("mysql2/promise"),i=t.n(n)().createPool({host:process.env.DB_HOST,user:process.env.DB_USER,password:process.env.DB_PASSWORD,database:process.env.DB_NAME,waitForConnections:!0,connectionLimit:10,queueLimit:0});async function o(){return await i.getConnection()}},8077:(e,r,t)=>{let n=t(7773),i=n.createLogger({level:"info",format:n.format.combine(n.format.timestamp(),n.format.printf(({level:e,message:r,timestamp:t})=>`${t} - ${e.toUpperCase()} - ${r}`)),transports:[new n.transports.Console,new n.transports.File({filename:"logs/error.log",level:"error"}),new n.transports.File({filename:"logs/combined.log"})]});e.exports={logger:i}},7153:(e,r)=>{var t;Object.defineProperty(r,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))},1802:(e,r,t)=>{e.exports=t(145)}};var r=require("../../../webpack-api-runtime.js");r.C(e);var t=r(r.s=1114);module.exports=t})();